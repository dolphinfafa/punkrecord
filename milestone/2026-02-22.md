# 2026-02-22 项目进度记录

## 今日工作总结

今天主要围绕 **项目管理模块（Project Management）** 的漏洞修复和功能完善进行。解决了项目中成员管理、经理更新以及相关数据导出的一些核心问题，确保了前后端的流程顺畅并恢复了项目管理页面的正常访问。

### 1. 修复项目导出的问题 (Excel Export)
- 增加了针对“报价单 (Quote) / 功能清单 (Features)”导出的前后端支持。
- 修复了因为代码丢失导致的多个项目导出接口（`export_quote_excel`, `export_features_excel`）无法访问的问题，通过 Python 脚本成功恢复了丢失的核心阶段 (B2B/B2C Stages) 配置以及导出代码逻辑。
- 完善了 Excel 报价单导出中的多表单（Sheet1和Sheet2）联动逻辑，并在导出的 Sheet2（功能清单）底部增加了按组统计的系统开发工时逻辑，满足了实际业务的结算需求。

### 2. 修复成员添加 500 报错 (Project Members)
- **问题根源**：后端在处理单体添加项目成员的接口时，错误地使用了批量添加的模型结构 `ProjectMemberBatchCreate`。
- **解决方案**：将 `add_project_member` 的接口 Schema 改回了只接受单用户 ID 的 `ProjectMemberCreate`，成功解决了解析报错导致的 500 错误。

### 3. 修复项目经理“未分配”的问题 (Project Manager Update)
- **问题根源**：项目经理虽然在数据库更新了 `pm_user_id`，但后端在返回项目详细信息时并没有从 `User` 表去关联查询经理的姓名；此外，前端部分更新表单字段（主体、甲方、开始时间）后端未正确接收并更新。
- **解决方案**：
  - 在 `project.py` 中增加了一个中间层拦截器 `enrich_project_response`。
  - 为所有查询项目信息的地方（列表、详情、新建、修改）自动注入查询结果，根据 `pm_user_id` 在 User 表中进行关联，获得项目经理人的 `display_name` 并在响应数据中通过 `pm_name` 输出给前端，保证界面实时显示项目经理的变更。
  - 顺带将之前漏掉的修改项目字段包括：`customer_id` (甲方), `our_entity_id` (我方主体), `start_at` (开始日期) 一并添加到项目修改保存流程。

### 4. 修复全站因为 User Name 引发的访问灾难
- **问题根源**：在使用 `enrich_project_response` 时，误用了 `User.name` 来获取用户名称。但在实际的 `User` DB 模型定义中，姓名字段名为 `display_name`。这导致了 `AttributeError` 生成 500 后端崩溃。
- **解决方案**：
  - 将所有相关的模块（`project.py`, 包括成员列表读取、成员添加返回、读取关联任务等）中的 `user.name` 严格替换为 `user.display_name`。
  - 涉及的字段包括：项目经理显示姓名 (`pm_name`)、项目成员列表姓名 (`user_name`)、关联代办任务认领人姓名 (`assignee_name`)。

## 待办 / 下一步计划
- 项目管理的基础逻辑目前已经非常健全了，下一步可以确认阶段汇报、阶段阻碍（Blocked Reason）、多成员消息打通或数据权限方面的功能支持。
