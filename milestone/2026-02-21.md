# Milestone: 2026-02-21 - Project Management Module Enhancements (Batch 2)

## Overview
Today's work focused on refining the Project Management module, specifically enhancing the user experience for team management, expanding B2B project capabilities, and fixing critical backend bugs related to data serialization.

## Key Achievements

### 1. Team Management Upgrades
- **Multi-Select Checkboxes:** Replaced the single-select dropdown with a more user-friendly, scrollable multi-select checkbox list for adding team members to a project.
- **Role Auto-Population:** Integrated with the IAM module to automatically fetch and assign a user's `JobTitle` as their role within the project, eliminating the need for manual role input.
- **PM Auto-Inclusion:** Added backend logic to automatically include the assigned Project Manager as a project member upon project creation or when the PM is updated.

### 2. B2B Project Features & UI Refinements
- **Date Fields Restored:** Re-introduced the "Start Date" and "Due Date" fields in both the Project Create and Edit modals.
- **B2B Counterparty Selection:** For B2B projects, dynamically rendered "Our Entity" (fetching from IAM `listEntities`) and "Customer" (fetching from Contract `listCounterparties`) dropdowns in the creation and edit modals.
- **Stage Progression:** Implemented manual stage control for B2B projects. Added a "Start Stage" action button in the project details view, allowing users to manually transition stages from "Not Started" to "In Progress".

### 3. Backend Bug Fixes
- **500 Error Resolution:** Fixed a `500 Internal Server Error` in the `add_project_member` and `list_project_members` APIs. The issue was caused by Pydantic's strict serialization dropping dynamic properties (`user_name`, `user_email`) attached to SQLAlchemy ORM instances. Fixed by assigning these properties directly to the validated Pydantic response objects.

### 4. Authentication Persistence & Security
- **Cookie-Based Auth:** Migrated the authentication system from vulnerable `localStorage` tokens to secure `HttpOnly` cookies.
- **Session API & Lifecycle:** Added backend `/auth/me` and `/auth/logout` endpoints. Updated the FastAPI `HTTPBearer` security dependency to gracefully fallback to cookie validation (`auto_error=False`).
- **Axios Configuration:** Updated frontend Axios interceptors to enforce `withCredentials: true` and correctly strip and parse user profile data during page refresh.

### 5. Dynamic Project Progress Calculation
- **Unified Progress Sync:** Implemented a new `sync_project_progress` backend helper function.
- **B2B Stage Linking:** Progress automatically recalculates (completed stages / total stages) whenever a project stage's status changes.
- **B2C Todo Linking:** Progress dynamically updates based on the completion ratio of tasks (Todos) mounted to the project.

### 6. UI Dropdown Fixes
- **Counterparty Integration:** Fixed the data source for "Our Entity" and "Customer" dropdowns in the Project Creation/Editing modals to fetch directly without strict type-filtering from the `counterparty` table.
- **PM Dropdown Resolution:** Fixed an unhandled promise rejection in `Promise.all` fetch requests that previously caused the "Project Manager" list to unexpectedly render empty.

### 7. AI Feature List Generation (B2B Requirement Alignment)
- **Database Schema Expansion**: Added a `feature_list` Text column to the `ProjectStage` SQLite database and Pydantic models to persistently store feature breakdown data.
- **REST Proxy Architecture**: Created a new `/api/v1/ai/chat` endpoint using `httpx` instead of the Google SDK to completely bypass local SSL proxy restrictions, integrating with the latest `gemini-2.5-flash` model.
- **System Prompting for Structured JSON**: Instructed Gemini via System Instructions to output exclusively well-formed JSON arrays mapping exactly to a 10-column data structure. 
- **10-Column Data Table UI**: Replaced the initial Markdown UI with a robust 10-column React Data Table (`FeatureListModal.jsx`), calculating frontend, backend, UI, and product development estimations.
- **One-Click JSON Parsing**: Built a "Apply to List" AI message action button that parses Gemini's JSON reply and dynamically overwrites the React Data Table state for immediate editing and saving. 

### 8. B2C Project Detail Refinements
- **Visible Stage Editing**: Removed B2B-only conditional rendering locks so that B2C consumers can also actively click "Edit Stage" on the Project Detail pages.
- **UI Table Rendering Fix**: Resolved a frontend bug where the "Planned End Date" column was missing in the `ProjectDetailPage` stages table rendering, misaligning the Action buttons.
- **Progress Task Type Fix**: Resolved an `AttributeError: PROJECT` crash happening during B2C status stage changes by swapping the Todo query type in `sync_project_progress` to the correct `TodoSourceType.PROJECT_TASK` enum.
