# 企业管理系统（代号：Atlas）总体PRD与技术规格（V1.0）
> 面向：研发团队 / AI编程工具  
> 目标：作为全系统“单一事实来源”（SSOT），为各模块PRD提供统一口径（数据模型/权限/事件/命名/集成点）  
> 版本：V1.0（2026-01-12）  
> 输出结构：本目录包含 1 个总项目文件 + 分模块 PRD 文件（合同/项目/财务/IAM/待办）

---

## 0. 系统宗旨与设计原则

### 0.1 宗旨
- 全业务线上化：可视化、规范化、流程化。
- 不增加员工负担：**默认自动化**、**最少必填**、**能从上下游推导就不让人填**。
- 可演进：V1先做闭环与一致性；V1.1+逐步增强（报表、导入、复杂权限、预算等）。

### 0.2 设计原则（必须遵守）
1. **统一身份与权限**：所有模块权限以 IAM 为准；模块内不自建用户体系。
2. **统一待办**：所有“需要某个人行动”的事项都落到 Todo 模块（统一入口/状态/审计）。
3. **统一审批**：合同审批、开票申请审批、报销审批全部复用通用审批引擎（Approval Engine）。
4. **统一附件与审计**：附件使用统一 File Service；所有关键动作写 AuditLog。
5. **可追溯关联**：合同—分期—流水—发票—项目之间必须能反查（join与跳转）。
6. **事件驱动但可同步落地**：V1允许同步调用（service-to-service）；同时定义事件规范以便后续异步化。

---

## 1. 模块清单与边界（V1）

### 1.1 模块
1) **IAM（人员与权限）**：用户、角色、权限、组织与主体（our_entity）管理。  
2) **Todo（个人待办/工作台）**：统一待办聚合与通知（不等于提醒，提醒由业务模块产生待办）。  
3) **合同模块**：合同全生命周期、分期、审批、AI生成/初步审核、尾款待办提醒（由合同模块产生Todo）。  
4) **项目模块**：B端/C端项目流程、阶段、任务拆解（任务本质为Todo的一种来源）。  
5) **财务模块**：账户（公账/股东私账）、流水、发票（OCR识别）、开票流程、报销流程，与合同分期打通（仅关联/回写，不在财务模块生成提醒）。

### 1.2 关键联通关系（必须实现）
- 合同 ↔ 项目：B端项目可关联合同（contract_id）；合同可反查关联项目。
- 合同 ↔ 财务：合同分期（payment_plan）↔ 流水（transaction）回写；发票/开票申请关联合同/分期。
- 项目 ↔ Todo：项目任务直接创建 Todo；Todo 可按项目聚合。
- 审批 ↔ Todo：每个待审批步骤自动生成 Todo（给审批人），审批完成自动关闭。
- IAM ↔ 全模块：所有资源读写鉴权、字段可见性（例如账户号）依赖 IAM。

---

## 2. 统一数据与命名规范（全系统一致）

### 2.1 ID与命名
- 统一使用 `uuid` 作为主键（字段名：`*_id`）。
- 表名使用 `snake_case`：如 `finance_transaction`。
- 枚举字段使用英文 code：如 `status=approved`。

### 2.2 时间与金额
- 时间统一：`created_at/updated_at`（datetime），业务日期用 `*_date`（date）。
- 金额统一：`decimal(18,2)`；币种 `currency` 默认 CNY（V1不做汇兑）。

### 2.3 多主体（our_entity）
- 所有“财务/合同/项目”记录必须绑定 `our_entity_id`（V1强制）。
- 权限未来可按 `our_entity_id` 隔离；但V1允许按配置放开查看（例如股东/财务可看所有）。

### 2.4 附件（File Service）
统一附件结构（所有模块一致）：
```json
{
  "file_id": "uuid-or-storage-key",
  "filename": "xxx.pdf",
  "content_type": "application/pdf",
  "size": 123456,
  "uploaded_at": "datetime",
  "uploaded_by": "user_id"
}
```

### 2.5 审计（AuditLog）
所有关键动作必须写审计：
- 创建/修改/删除（软删）核心对象
- 状态流转（审批、付款、开票、阶段推进）
- OCR结果确认与人工修正
- 权限与角色变更

---

## 3. 共享基础数据模型（跨模块复用）

### 3.1 我方主体 our_entity（来自 IAM）
- 多主体支持：例如不同公司主体、不同分公司。
- 主体与印章管理员、财务负责人等可绑定（用于审批与权限默认值）。

### 3.2 对方主体 counterparty（来自合同模块，供全系统复用）
- 客户/供应商/合作方等，用于合同、流水、发票、项目。

### 3.3 通用审批引擎（Approval Engine）
在本系统中作为共享组件，数据模型在 `40_iam_prd.md` 中定义，所有模块复用：
- `approval_instance`
- `approval_step`

### 3.4 通用待办（Todo Engine）
统一待办表 `todo_item` 在 `50_todo_prd.md` 中定义：
- 项目任务、合同提醒、审批待办、财务复核事项（可选）全部统一进入。

---

## 4. 统一权限模型（摘要）
详细见 `40_iam_prd.md`，此处仅给系统级要求：
- 采用 RBAC：用户可拥有多个角色；角色绑定权限点（permission）。
- V1最小实现为“模块权限 + 主体范围（our_entity）”；后续扩展到项目/合同范围。
- 明确：`finance` 与 `shareholder` 默认拥有**全账务明细读权限**（含公账、私账）。

---

## 5. 统一待办与通知策略（摘要）
详细见 `50_todo_prd.md`。
- 待办 = 需要人行动的事项；来源包括：审批步骤、合同尾款提醒、项目任务等。
- 通知策略（V1）：站内通知 + 可选邮件/企业微信/飞书（接口预留）。
- **提醒不在财务模块生成**：若需要“付款/开票提醒”，由合同模块基于分期/验收节点生成待办。

---

## 6. 跨模块关键业务闭环（V1必须跑通）

### 6.1 B端交付与回款闭环
1) 创建 B端项目（project_type=b2b）  
2) 项目推进到“签合同”阶段：关联合同 contract_id  
3) 合同审批通过并签署，生成分期 payment_plan  
4) 财务录入回款流水并关联到分期，系统回写分期 paid_amount/status  
5) 合同资金进度自动更新；合同尾款到期前1个月生成销售待办（Todo）  
6) 项目交付验收后关闭项目/合同履约状态更新（以合同模块规则为准）

### 6.2 C端产品上线闭环
1) 创建 C端项目（project_type=b2c）并拆解任务（Todo）  
2) 任务分配到个人，每人通过 Todo 工作台执行  
3) 项目阶段推进与进度自动计算  
4) 上线后进入运营与迭代阶段（V1先单次循环，V1.1支持多版本迭代）

### 6.3 报销闭环
1) 员工提交报销单 -> 审批（Todo给审批人）  
2) 审批通过 -> 财务/出纳付款（生成出账流水）  
3) 报销状态 paid，流水可关联到报销对象（对账闭环）

---

## 7. 目录结构与交付物（本次输出）
- `00_master_prd.md`：总体PRD（本文件）
- `10_contract_prd.md`：合同模块PRD
- `20_project_prd.md`：项目模块PRD
- `30_finance_prd.md`：财务模块PRD
- `40_iam_prd.md`：人员与权限管理PRD（含审批引擎）
- `50_todo_prd.md`：Todo与工作台PRD

---

## 8. V1里程碑建议（供研发拆分）
- M1：IAM + 基础字典（our_entity/user/role/permission） + AuditLog + File Service占位
- M2：Todo引擎 + 工作台（含审批待办）
- M3：合同模块（审批、分期、尾款待办）+ 与Todo打通
- M4：项目模块（阶段、进度、任务=Todo）+ 与合同关联
- M5：财务模块（账户/流水/发票OCR/开票/报销）+ 与合同分期回写

---
