# 微信小程序模块 PRD/功能与技术规格说明（V1.0）
> 面向：研发团队 / AI 编程工具  
> 版本：V1.0（2026-01-20）  
> 依赖：后端API（IAM/Todo/Contract/Project/Finance）  
> 说明：微信小程序作为移动端入口，复用后端API，提供移动场景核心功能。

---

## 0. 背景与目标

### 0.1 目标（V1）
- 提供移动端访问能力，方便员工随时随地处理待办、查看项目与合同进度。
- 支持微信登录与企业微信集成（预留接口）。
- 核心功能：个人工作台（Todo）、合同查看、项目进度、财务查看（按权限）。
- 支持消息通知与待办提醒（通过微信服务号/小程序订阅消息）。

### 0.2 非目标（V1不做）
- 不做复杂表单录入（创建合同/项目等仍在Web端完成）。
- 不做OCR扫描（依赖后端OCR能力）。
- 不做离线能力。

---

## 1. 系统架构

### 1.1 架构模式
```
┌─────────────────┐
│  WeChat Mini    │
│    Program      │ ← 微信小程序前端（WXML/WXSS/JS）
└────────┬────────┘
         │ HTTPS/REST API
         ↓
┌─────────────────┐
│  Backend API    │
│   (FastAPI)     │ ← 复用Web端后端API
└─────────────────┘
```

### 1.2 技术栈
- **前端框架**：微信小程序原生开发（或 uni-app 跨平台方案作为备选）
- **后端API**：完全复用FastAPI后端，小程序仅作为新客户端
- **认证**：JWT Token + 微信登录（openid/unionid绑定user_id）
- **通知**：微信订阅消息（待办提醒/审批通知）

---

## 2. 核心功能模块（V1最小集）

### 2.1 登录与认证
- **微信登录**：
  - 用户授权获取 `code` → 后端调用微信API换取 `openid`/`unionid`
  - 绑定系统 `user_id`（首次绑定或自动创建用户）
  - 返回JWT Token供后续API调用
- **企业微信登录**（V1.1）：预留接口

### 2.2 个人工作台（Todo）
- **我的待办列表**：
  - 按状态筛选（open/in_progress/blocked）
  - 按截止时间筛选（今天/本周/逾期）
  - 按来源筛选（项目任务/审批/合同提醒）
- **待办详情**：
  - 展示待办信息与关联对象
  - 支持操作：完成、阻塞、跳转关联对象
- **审批待办**：
  - 跳转审批详情页
  - 支持审批通过/驳回（填写意见）

### 2.3 合同管理（只读为主）
- **合同列表**：
  - 按类型/状态/我方主体筛选
  - 展示资金进度与履约状态
- **合同详情**：
  - 基本信息、分期、附件预览（PDF/图片）
  - 关联项目与流水（可跳转）
- **合同审批**（从待办进入）：
  - 查看合同正文与附件
  - 审批操作（通过/驳回）

### 2.4 项目管理（只读为主）
- **项目列表**：
  - 按类型/状态/负责人筛选
  - 展示进度与当前阶段
- **项目详情**：
  - 阶段看板（可视化进度）
  - 项目任务列表（来自Todo，可完成）
  - 关联合同（可跳转）

### 2.5 财务查看（按权限）
- **账户余额**（仅 finance/shareholder 可见全部）：
  - 公账/私账列表与余额
- **流水查询**（按权限）：
  - 筛选与搜索
  - 流水详情（关联合同/分期/发票）
- **发票查看**（按权限）：
  - 发票列表与详情
  - 附件预览

### 2.6 消息通知
- **订阅消息**：
  - 待办到期提醒
  - 审批通知（有新审批/审批结果）
  - 合同尾款提醒
- **站内消息中心**：
  - 消息列表（已读/未读）
  - 跳转关联对象

---

## 3. 数据模型（后端扩展）

### 3.1 微信用户绑定 wechat_user_binding
**表：`wechat_user_binding`**
- `binding_id` (uuid) PK
- `user_id` (uuid) fk 必填
- `openid` (string) 唯一必填
- `unionid` (string) 选填（企业微信场景）
- `nickname` (string) 选填
- `avatar_url` (string) 选填
- `subscribe_status` (enum) 必填：`subscribed|unsubscribed`
- `created_at`, `updated_at`

### 3.2 订阅消息模板配置（可选）
**表：`wechat_message_template`**
- `template_id` PK
- `template_code` (string) 唯一（如 `todo_due_reminder`）
- `wx_template_id` (string) 微信模板ID
- `name` (string) 必填
- `is_active` (bool) 默认 true

---

## 4. API设计（后端扩展）

### 4.1 微信登录
- `POST /auth/wechat/login`
  - 入参：`code`（微信授权码）
  - 出参：`access_token`, `user_id`, `is_new_user`

### 4.2 Todo API（复用）
- `GET /todo/my`
- `POST /todo/{todo_id}/done`
- `POST /todo/{todo_id}/block`

### 4.3 合同/项目/财务API（复用）
- 完全复用Web端API，小程序仅作为新客户端
- 需要确保API返回格式适配移动端（精简字段/分页）

### 4.4 通知API
- `POST /wechat/subscribe` - 订阅消息
- `POST /wechat/send-notification` - 后端发送订阅消息（内部调用）

---

## 5. 页面结构（V1最小）

### 5.1 Tab导航（底部）
- **工作台**：我的待办（默认首页）
- **合同**：合同列表
- **项目**：项目列表
- **我的**：个人中心（消息/设置/账户切换）

### 5.2 核心页面
- 登录页
- 工作台（待办列表）
- 待办详情
- 审批详情页
- 合同列表/详情
- 项目列表/详情
- 财务列表（账户/流水/发票）
- 消息中心
- 个人中心

---

## 6. 与后端联动（关键集成点）

### 6.1 认证与鉴权
- 小程序每次请求携带JWT Token（存储在storage）
- 后端复用现有权限体系（RBAC），按用户角色返回数据

### 6.2 待办同步
- 小程序Todo列表实时调用后端API
- 后端待办变更时，通过订阅消息推送提醒

### 6.3 审批流程
- 小程序支持查看审批详情与操作（通过/驳回）
- 审批结果写入后端，触发待办关闭与下一步骤

### 6.4 通知推送
- 后端在生成待办/审批步骤/合同提醒时，调用微信订阅消息API
- 用户点击通知直接跳转到小程序对应页面

---

## 7. 开发阶段（建议里程碑）

### P1：基础能力（优先）
- 微信登录与用户绑定
- 工作台（待办列表与详情）
- 审批待办查看与操作

### P2：只读查询
- 合同列表与详情
- 项目列表与详情
- 财务查看（按权限）

### P3：通知与消息
- 订阅消息配置与发送
- 站内消息中心

---

## 8. 验收标准（UAT）

- UAT-MP-001：微信登录可用，openid与user_id绑定正确。
- UAT-MP-002：工作台展示待办列表，筛选与完成操作可用。
- UAT-MP-003：审批待办可查看详情并操作（通过/驳回），后端状态联动更新。
- UAT-MP-004：合同/项目列表可查看，详情页附件预览可用。
- UAT-MP-005：财务查看按权限生效（finance/shareholder可见全部）。
- UAT-MP-006：订阅消息可配置并推送（测试待办到期提醒）。

---
